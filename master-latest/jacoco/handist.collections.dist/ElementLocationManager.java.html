<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ElementLocationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">handistCollections</a> &gt; <a href="index.source.html" class="el_package">handist.collections.dist</a> &gt; <span class="el_source">ElementLocationManager.java</span></div><h1>ElementLocationManager.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2021 Handy Tools for Distributed Computing (HanDist) project.
 *
 * This program and the accompanying materials are made available to you under
 * the terms of the Eclipse Public License 1.0 which accompanies this
 * distribution,
 * and is available at https://www.eclipse.org/legal/epl-v10.html
 *
 * SPDX-License-Identifier: EPL-1.0
 ******************************************************************************/
package handist.collections.dist;

import static apgas.Constructs.*;

import java.util.Collection;
import java.util.HashSet;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import apgas.Place;
import handist.collections.ElementOverlapException;
import handist.collections.dist.util.ObjectInput;
import handist.collections.dist.util.ObjectOutput;
import handist.collections.function.DeSerializerUsingPlace;
import handist.collections.function.Serializer;

/**
 * This class manages the elements of a distributed collection in a
 * difference-basis.
 *
 * @param &lt;T&gt; the type of the unit of index/key management. Currently
 *            {@code Long} and {@code LongRange} are supported.
 */
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">public class ElementLocationManager&lt;T&gt; {</span>

    static class ParameterErrorException extends RuntimeException {
        /**
         *
         */
        private static final long serialVersionUID = -9038636040813564069L;
        public int reason;

        ParameterErrorException(int reason, String msg) {
<span class="nc" id="L44">            super(msg);</span>
<span class="nc" id="L45">            this.reason = reason;</span>
<span class="nc" id="L46">        }</span>
    };

    /*
     * public static class Range extends DistManager&lt;LongRange&gt; { }
     */

    static class SystemError extends Error {
        /**
         *
         */
        private static final long serialVersionUID = 4466816572543219426L;
        public int reason;

        SystemError(int reason, String msg) {
<span class="nc" id="L61">            super(msg);</span>
<span class="nc" id="L62">            this.reason = reason;</span>
<span class="nc" id="L63">        }</span>
    }

    public static final int DIST_ADDED = 1;
    /** Code for key received from remote place to this local handle */
    public static final int DIST_MOVED_IN = 4;
    public static final int DIST_REMOVED = 2;

    public static final byte MOVE_NEW = 1; // New range created on local handle
    public static final byte MOVE_NONE = 0;
    public static final byte MOVE_OLD = 2;

    /**
     * Changes since that last time updateDist was called that will need to be
     * notified to remote places. There may be other changes that occurred on remote
     * places that this local handle is not yet aware of.
     */
<span class="fc" id="L80">    public ConcurrentHashMap&lt;T, Integer&gt; diff = new ConcurrentHashMap&lt;&gt;();</span>
    /** Current knowledge of the key-holding information on local &amp; remote places */
<span class="fc" id="L82">    public ConcurrentHashMap&lt;T, Place&gt; dist = new ConcurrentHashMap&lt;&gt;();</span>

<span class="fc" id="L84">    HashSet&lt;T&gt; importedDiffKeys = new HashSet&lt;&gt;();</span>

    public void add(T key) throws ElementOverlapException {
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (distHasKey(key)) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (distIsLocal(key)) {</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                if (diffHasKey(key)) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                    if (diffOfKeyIs(key, (DIST_ADDED | DIST_MOVED_IN))) {</span>
<span class="nc" id="L91">                        reject(&quot;add&quot;, 103, key);</span>
                    } else {
<span class="nc" id="L93">                        systemError(&quot;add&quot;, 104, key);</span>
                    }
                } else {
<span class="nc" id="L96">                    reject(&quot;add&quot;, 102, key);</span>
                }
            } else {
<span class="nc" id="L99">                reject(&quot;add&quot;, 105, key);</span>
            }
        } else {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            if (diffHasKey(key)) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                if (diffOfKeyIs(key, DIST_REMOVED)) {</span>
<span class="nc" id="L104">                    diff.remove(key);</span>
<span class="nc" id="L105">                    dist.put(key, here());</span>
                } else {
<span class="nc" id="L107">                    systemError(&quot;add&quot;, 101, key);</span>
                }
            } else {
<span class="fc" id="L110">                diff.put(key, DIST_ADDED);</span>
<span class="fc" id="L111">                dist.put(key, here());</span>
            }
        }
<span class="fc" id="L114">    }</span>

    void applyDiff(T key, int operation, Place from) throws Exception {
        // System.out.println(&quot;[&quot; + here.id + &quot;] applyDiff &quot; + key + &quot; op: &quot; + operation
        // + &quot; from: &quot; + from.id);
<span class="pc bpc" id="L119" title="2 of 4 branches missed.">        if (importedDiffKeys.contains(key) || diff.containsKey(key)) {</span>
<span class="nc" id="L120">            reject(&quot;applyDiff with duplicate key &quot;, operation, key);</span>
        } else {
<span class="fc" id="L122">            importedDiffKeys.add(key);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            if ((operation &amp; (DIST_ADDED | DIST_MOVED_IN)) != 0) {</span>
<span class="fc" id="L124">                dist.put(key, from);</span>
            } else {
                // operation == DIST_REMOVED
<span class="fc" id="L127">                dist.remove(key);</span>
            }
        }
<span class="fc" id="L130">    }</span>

    public void clear() {
<span class="nc" id="L133">        dist.clear();</span>
<span class="nc" id="L134">        diff.clear();</span>
<span class="nc" id="L135">    }</span>

    public boolean diffHasKey(T key) {
<span class="fc" id="L138">        return diff.containsKey(key);</span>
    }

    public boolean diffOfKeyIs(T key, int operation) {
<span class="fc bfc" id="L142" title="All 2 branches covered.">        return (diff.get(key) &amp; operation) != 0;</span>
    }

    public boolean distHasKey(T key) {
<span class="fc" id="L146">        return dist.containsKey(key);</span>
    }

    public boolean distIsLocal(T key) {
<span class="fc bfc" id="L150" title="All 2 branches covered.">        return dist.get(key) == here();</span>
    }

    public void moveInNew(T key) throws Exception {
        // System.out.println(&quot;&gt;&gt;&gt; moveInNew &quot; + key + &quot; distHasKey: &quot; + distHasKey(key)
        // + &quot; diffHasKey: &quot; + diffHasKey(key));

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (distHasKey(key)) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (distIsLocal(key)) {</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">                if (diffHasKey(key) &amp;&amp; diffOfKeyIs(key, DIST_ADDED)) {</span>
<span class="nc" id="L160">                    reject(&quot;moveInNew&quot;, 402, key);</span>
                } else {
<span class="nc" id="L162">                    systemError(&quot;moveInNew&quot;, 403, key);</span>
                }
            } else {
                // !distIsLocal(key)
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (diffHasKey(key)) {</span>
<span class="nc" id="L167">                    systemError(&quot;moveInNew&quot;, 404, key);</span>
                } else {
                    // System.out.println(&quot;&gt;&gt;&gt; AAA&quot;);
<span class="nc" id="L170">                    diff.put(key, DIST_ADDED);</span>
<span class="nc" id="L171">                    dist.put(key, here());</span>
                }
            }
        } else {
            // !distHasKey(key)
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">            if (diffHasKey(key)) {</span>
<span class="nc" id="L177">                systemError(&quot;moveInNew&quot;, 401, key);</span>
            } else {
                // System.out.println(&quot;&gt;&gt;&gt; BBB&quot;);
<span class="fc" id="L180">                diff.put(key, DIST_ADDED);</span>
<span class="fc" id="L181">                dist.put(key, here());</span>
            }
        }
<span class="fc" id="L184">    }</span>

    public void moveInOld(T key) throws Exception {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (distHasKey(key)) {</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">            if (distIsLocal(key)) {</span>
<span class="nc" id="L189">                systemError(&quot;moveInOld&quot;, 406, key);</span>
            } else {
                // !distIsLocal(key)
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                if (diffHasKey(key)) {</span>
<span class="nc" id="L193">                    systemError(&quot;moveInOld&quot;, 407, key);</span>
                } else {
<span class="fc" id="L195">                    diff.put(key, DIST_MOVED_IN);</span>
<span class="fc" id="L196">                    dist.put(key, here());</span>
                }
            }
        } else {
            // !distHasKey(key)
<span class="nc" id="L201">            systemError(&quot;moveInOld&quot;, 405, key);</span>
        }
<span class="fc" id="L203">    }</span>

    public byte moveOut(T key, Place dest) {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (distHasKey(key)) {</span>
            // System.out.println(&quot;&gt;&gt;&gt; distHasKey&quot;);
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (distIsLocal(key)) {</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">                if (diffHasKey(key)) {</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">                    if (diffOfKeyIs(key, DIST_ADDED)) {</span>
<span class="fc" id="L211">                        diff.remove(key);</span>
<span class="fc" id="L212">                        dist.remove(key);</span>
<span class="fc" id="L213">                        return MOVE_NEW;</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                    } else if (diffOfKeyIs(key, DIST_MOVED_IN)) {</span>
<span class="fc" id="L215">                        diff.remove(key);</span>
<span class="fc" id="L216">                        dist.put(key, dest);</span>
<span class="fc" id="L217">                        return MOVE_OLD;</span>
                    } else {
<span class="nc" id="L219">                        systemError(&quot;moveOut&quot;, 804, key);</span>
                    }
                } else {
<span class="fc" id="L222">                    dist.put(key, dest);</span>
<span class="fc" id="L223">                    return MOVE_OLD;</span>
                }
            } else {
                // !distIsLocal(key)
<span class="nc" id="L227">                reject(&quot;moveOut&quot;, 805, key);</span>
            }
        } else {
            // !distHasKey(key)
            // System.out.println(&quot;&gt;&gt;&gt; !distHasKey&quot;);
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (diffHasKey(key)) {</span>
                // System.out.println(&quot;&gt;&gt;&gt; diffHasKey&quot;);
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (diffOfKeyIs(key, DIST_REMOVED)) {</span>
<span class="nc" id="L235">                    reject(&quot;moveOut&quot;, 802, key);</span>
                } else {
<span class="nc" id="L237">                    systemError(&quot;moveOut&quot;, 803, key);</span>
                }
            } else {
                // System.out.println(&quot;&gt;&gt;&gt; !diffHasKey&quot;);
<span class="nc" id="L241">                reject(&quot;moveOut&quot;, 801, key);</span>
            }
        }
        // System.out.println(&quot;&gt;&gt;&gt; MOVE_NONE&quot;);
<span class="nc" id="L245">        return MOVE_NONE;</span>
    }

    void reject(String method, int reason, T key) throws ParameterErrorException {
<span class="nc" id="L249">        final String msg = &quot;[&quot; + here() + &quot;] Error when calling &quot; + method + &quot; &quot; + key + &quot; on code &quot; + reason;</span>
<span class="nc" id="L250">        System.err.println(msg);</span>
<span class="nc" id="L251">        throw new ParameterErrorException(reason, msg);</span>
    }

    public void remove(T key) {
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">        if (distHasKey(key)) {</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">            if (distIsLocal(key)) {</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">                if (diffHasKey(key)) {</span>
                    // System.out.println(&quot;[&quot; + here.id + &quot;] remove key &quot; + key);
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                    if (diffOfKeyIs(key, DIST_ADDED)) {</span>
<span class="fc" id="L260">                        diff.remove(key);</span>
<span class="fc" id="L261">                        dist.remove(key);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                    } else if (diffOfKeyIs(key, DIST_MOVED_IN)) {</span>
<span class="nc" id="L263">                        diff.put(key, DIST_REMOVED);</span>
<span class="nc" id="L264">                        dist.remove(key);</span>
                    } else {
<span class="nc" id="L266">                        systemError(&quot;remove&quot;, 202, key);</span>
                    }
                } else {
<span class="fc" id="L269">                    diff.put(key, DIST_REMOVED);</span>
<span class="fc" id="L270">                    dist.remove(key);</span>
                }
            } else {
                // !distIsLocal(key)
<span class="nc" id="L274">                reject(&quot;remove&quot;, 203, key);</span>
            }
        } else {
            // !distHasKey(key)
<span class="nc" id="L278">            reject(&quot;remove&quot;, 201, key);</span>
        }
<span class="fc" id="L280">    }</span>

    void setup(Collection&lt;T&gt; keys) {
<span class="pc bpc" id="L283" title="3 of 4 branches missed.">        assert (keys.isEmpty());</span>
        try {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">            for (final T k : keys) {</span>
<span class="nc" id="L286">                add(k);</span>
<span class="nc" id="L287">            }</span>
<span class="nc" id="L288">        } catch (final Exception e) {</span>
<span class="nc" id="L289">            throw new RuntimeException(&quot;[DistManager] Duplicate key in &quot; + keys);</span>
<span class="fc" id="L290">        }</span>
<span class="fc" id="L291">    }</span>

    void systemError(String method, int reason, T key) throws SystemError {
<span class="nc" id="L294">        final String msg = &quot;[&quot; + here() + &quot;] System Error when calling &quot; + method + &quot; &quot; + key + &quot; on code &quot; + reason;</span>
<span class="nc" id="L295">        System.err.println(msg);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (reason &gt; 0) {</span>
<span class="nc" id="L297">            throw new SystemError(reason, msg);</span>
        }
<span class="nc" id="L299">        throw new SystemError(reason, msg);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L304">        return &quot;[DistManager] + dist: &quot; + dist + &quot;,  diff: &quot; + diff + &quot;, imported: &quot; + importedDiffKeys + &quot;-----&quot;;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    void updateDist(TeamedPlaceGroup pg) {
<span class="fc" id="L309">        final Serializer serProcess = (ObjectOutput s) -&gt; {</span>
<span class="fc" id="L310">            s.writeObject(diff);</span>
<span class="fc" id="L311">        };</span>
<span class="fc" id="L312">        final DeSerializerUsingPlace desProcess = (ObjectInput ds, Place from) -&gt; {</span>
<span class="fc" id="L313">            final Map&lt;T, Integer&gt; importedDiff = (Map&lt;T, Integer&gt;) ds.readObject();</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            for (final Map.Entry&lt;T, Integer&gt; entry : importedDiff.entrySet()) {</span>
<span class="fc" id="L315">                final T k = entry.getKey();</span>
<span class="fc" id="L316">                final Integer v = entry.getValue();</span>
<span class="fc" id="L317">                applyDiff(k, v, from);</span>
<span class="fc" id="L318">            }</span>
<span class="fc" id="L319">        };</span>
<span class="fc" id="L320">        new CollectiveRelocator.Allgather(pg).request(serProcess, desProcess).execute();</span>
<span class="fc" id="L321">        importedDiffKeys.clear();</span>
<span class="fc" id="L322">        diff.clear();</span>
<span class="fc" id="L323">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>