<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProgramStatistics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">handistCollections</a> &gt; <a href="index.source.html" class="el_package">handist.collections.glb.util</a> &gt; <span class="el_source">ProgramStatistics.java</span></div><h1>ProgramStatistics.java</h1><pre class="source lang-java linenums">package handist.collections.glb.util;

import static handist.collections.glb.GlobalLoadBalancer.*;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.PrintStream;
import java.util.Arrays;
import java.util.Collection;
import java.util.function.Consumer;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.DefaultParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;

import handist.collections.dist.DistLog.LogItem;
import handist.collections.glb.GlobalLoadBalancer;
import handist.collections.util.SavedLog;

public class ProgramStatistics {

    private static final String OPT_WORKER_OVER_TIME = &quot;w&quot;;

    private static Options commandOptions() {
<span class="nc" id="L28">        final Options opts = new Options();</span>
<span class="nc" id="L29">        opts.addOption(OPT_WORKER_OVER_TIME, &quot;worker&quot;, true,</span>
                &quot;produces a CSV showing the proportion of workers active over time&quot;);
<span class="nc" id="L31">        opts.addOption(&quot;f&quot;, false, &quot;if the generation of files would result in some being overwritten, this program &quot;</span>
                + &quot;normally skips these files; use this option to force the overwriting of existing files&quot;);
<span class="nc" id="L33">        opts.addOption(&quot;v&quot;, false,</span>
                &quot;verbose output; if activated, will print the contents of the log on the standard output&quot;);
<span class="nc" id="L35">        return opts;</span>
    }

    /**
     * Program which obtains a GlbLog from a file and produces various CSV exports
     * on demand.
     *
     * @param args (option)+ &lt;log file&gt;
     */
    public static void main(String[] args) {
        // Check that at least the input log file is specified
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (args.length &lt;= 1) {</span>
<span class="nc" id="L47">            final Options opt = commandOptions();</span>
<span class="nc" id="L48">            new HelpFormatter().printHelp(&quot;(options)+ &lt;log input file&gt;&quot;, opt);</span>
<span class="nc" id="L49">            return;</span>
        }

        // Open the input log file
<span class="nc" id="L53">        SavedLog log = null;</span>
<span class="nc" id="L54">        final String inputFileName = args[args.length - 1];</span>
<span class="nc" id="L55">        final File f = new File(inputFileName);</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!f.exists()) {</span>
<span class="nc" id="L57">            System.err.println(&quot;Could not read file &quot; + inputFileName);</span>
<span class="nc" id="L58">            System.err.println(&quot;Exiting with code -1&quot;);</span>
<span class="nc" id="L59">            System.exit(-1);</span>
        }
        try {
<span class="nc" id="L62">            log = new SavedLog(f);</span>
<span class="nc" id="L63">        } catch (final Exception e) {</span>
<span class="nc" id="L64">            System.err.println(&quot;A problem occurred while parsing input file &quot; + inputFileName);</span>
<span class="nc" id="L65">            e.printStackTrace();</span>
<span class="nc" id="L66">            System.exit(-2);</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">        final ProgramStatistics statFactory = new ProgramStatistics(log);</span>

        // Now that the input file has been successfully parsed,
        // check which program outputs are desired
<span class="nc" id="L72">        final Options programOptions = commandOptions();</span>
<span class="nc" id="L73">        final CommandLineParser parser = new DefaultParser();</span>
<span class="nc" id="L74">        CommandLine cmd = null;</span>
<span class="nc" id="L75">        final String[] optionArray = Arrays.copyOf(args, args.length - 1); // remove the input file from the options</span>
        try {
<span class="nc" id="L77">            cmd = parser.parse(programOptions, optionArray);</span>
<span class="nc" id="L78">        } catch (final ParseException e1) {</span>
<span class="nc" id="L79">            System.err.println(e1.getLocalizedMessage());</span>
<span class="nc" id="L80">            final HelpFormatter formatter = new HelpFormatter();</span>
<span class="nc" id="L81">            formatter.printHelp(</span>
<span class="nc" id="L82">                    &quot;java [...] &quot; + ProgramStatistics.class.getCanonicalName() + &quot; [options]* &lt;input log file&gt;&quot;,</span>
                    programOptions);
<span class="nc" id="L84">            return;</span>
<span class="nc" id="L85">        }</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (cmd.hasOption(&quot;v&quot;)) {</span>
<span class="nc" id="L88">            log.printAll(System.out);</span>
        }

        // Check if the &quot;force overwrite&quot; option is set
<span class="nc" id="L92">        final boolean overwriteFiles = cmd.hasOption(&quot;f&quot;);</span>

        // Produce each output in the specified files
<span class="nc" id="L95">        makeOutputToFile(cmd, OPT_WORKER_OVER_TIME, statFactory::workerActivity, overwriteFiles);</span>
<span class="nc" id="L96">    }</span>

    /**
     * Generic method used to check whether an option was set
     *
     * @param option
     * @param outputMethod
     */
    private static void makeOutputToFile(CommandLine cmd, String option, Consumer&lt;PrintStream&gt; outputMethod,
            boolean overwriteFiles) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (cmd.hasOption(option)) {</span>
<span class="nc" id="L107">            final File output = new File(cmd.getOptionValue(option));</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">            if (output.exists() &amp;&amp; !overwriteFiles) {</span>
<span class="nc" id="L109">                System.err.println(&quot;File &quot; + output.getAbsolutePath() + &quot; already exists, skipping&quot;);</span>
            } else {
                PrintStream ps;
                try {
<span class="nc" id="L113">                    ps = new PrintStream(output);</span>
<span class="nc" id="L114">                    outputMethod.accept(ps);</span>
<span class="nc" id="L115">                    ps.close();</span>
<span class="nc" id="L116">                } catch (final FileNotFoundException e) {</span>
<span class="nc" id="L117">                    System.err.println(&quot;A problem occurred while writing to &quot; + output.getAbsolutePath());</span>
<span class="nc" id="L118">                    e.printStackTrace();</span>
<span class="nc" id="L119">                }</span>
<span class="nc" id="L120">                System.out.println(&quot;Wrote file &quot; + output.getAbsolutePath());</span>
            }
        }
<span class="nc" id="L123">    }</span>

    /**
     * Logger of a GLB execution. Is used by this class to produce various data
     * tables to generates various plots about the glb execution considered
     */
    final private SavedLog log;

    /**
     * Constructor
     *
     * @param logger DistLog instance retrieved through method
     *               {@link GlobalLoadBalancer#getPreviousLog()}
     */
<span class="nc" id="L137">    public ProgramStatistics(SavedLog logger) {</span>
<span class="nc" id="L138">        log = logger;</span>
<span class="nc" id="L139">    }</span>

    /**
     * Produces a data output of the number of workers running, yielding, and
     * inactive on each host over time.
     *
     * @param ps the printstream onto which the data needs to be printed
     */
    public void workerActivity(PrintStream ps) {
<span class="nc" id="L148">        ps.println(&quot;# TimeStamp(s) InactiveWorker YieldingWorker RunningWorker&quot;);</span>
        // First obtain the entire program computation time
<span class="nc" id="L150">        long programStart = 0, programEnd = -1;</span>
<span class="nc" id="L151">        final Collection&lt;LogItem&gt; underGlbItems = log.getLog(0, LOGKEY_UNDER_GLB, 0);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        for (final LogItem item : underGlbItems) {</span>
<span class="nc bnc" id="L153" title="All 3 branches missed.">            switch (item.msg) {</span>
            case LOG_PROGRAM_STARTED:
<span class="nc" id="L155">                programStart = Long.parseLong(item.appendix);</span>
<span class="nc" id="L156">                break;</span>
            case LOG_PROGRAM_ENDED:
<span class="nc" id="L158">                programEnd = Long.parseLong(item.appendix);</span>
<span class="nc" id="L159">                break;</span>
            default:
                // Other potential items ignored
            }
<span class="nc" id="L163">        }</span>
<span class="nc" id="L164">        final long TOTAL_COMPUTATION_TIME = programEnd - programStart;</span>

        // For each host in the computation
<span class="nc bnc" id="L167" title="All 2 branches missed.">        for (int place = 0; place &lt; log.placeCount(); place++) {</span>
<span class="nc" id="L168">            ps.println(&quot;# place(&quot; + place + &quot;)&quot;);</span>

<span class="nc" id="L170">            int workerCount = -1;</span>
<span class="nc" id="L171">            long referenceNanoTime = -1l;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            for (final LogItem item : log.getLog(place, LOGKEY_GLB, 0)) {</span>
<span class="nc bnc" id="L173" title="All 3 branches missed.">                switch (item.msg) {</span>
                case LOG_INITIALIZED_AT_NANOTIME:
<span class="nc" id="L175">                    referenceNanoTime = Long.parseLong(item.appendix);</span>
<span class="nc" id="L176">                    break;</span>
                case LOG_INITIALIZED_WORKERS:
<span class="nc" id="L178">                    workerCount = Integer.parseInt(item.appendix);</span>
<span class="nc" id="L179">                    break;</span>
                default:
                    // Other messages are ignored
                }

<span class="nc" id="L184">            }</span>

            // At first, all workers are inactive
<span class="nc" id="L187">            int inactive = workerCount;</span>
<span class="nc" id="L188">            int yielding = 0;</span>
<span class="nc" id="L189">            int running = 0;</span>

            // First line output
<span class="nc" id="L192">            ps.println(String.format(&quot;%s %s %s %s&quot;, 0l, inactive, yielding, running));</span>

            // For each &quot;worker&quot; event, update and print the new worker status
<span class="nc" id="L195">            final Collection&lt;LogItem&gt; workerEvents = log.getLog(place, LOGKEY_WORKER, 0);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (workerEvents != null) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                for (final LogItem item : log.getLog(place, LOGKEY_WORKER, 0)) {</span>
                    // FIXME add the update of the timestamp
<span class="nc" id="L199">                    final double stamp = (Long.parseLong(item.appendix) - referenceNanoTime) / 1e9;</span>
<span class="nc bnc" id="L200" title="All 5 branches missed.">                    switch (item.msg) {</span>
                    case LOG_WORKER_STARTED:
<span class="nc" id="L202">                        inactive--;</span>
<span class="nc" id="L203">                        running++;</span>
<span class="nc" id="L204">                        break;</span>
                    case LOG_WORKER_YIELDING:
<span class="nc" id="L206">                        yielding++;</span>
<span class="nc" id="L207">                        running--;</span>
<span class="nc" id="L208">                        break;</span>
                    case LOG_WORKER_RESUMED:
<span class="nc" id="L210">                        yielding--;</span>
<span class="nc" id="L211">                        running++;</span>
                    case LOG_WORKER_STOPPED:
<span class="nc" id="L213">                        running--;</span>
<span class="nc" id="L214">                        inactive++;</span>
                    default:
                        // in other cases, ignore the logged entry
                    }
                    // Even if there were no changes, this has no adverse effect on the plot
<span class="nc" id="L219">                    ps.println(String.format(&quot;%s %s %s %s&quot;, stamp, inactive, yielding, running));</span>
<span class="nc" id="L220">                }</span>
            }

            // Last line with &quot;end of computation&quot;
<span class="nc" id="L224">            ps.println(String.format(&quot;%s %s %s %s&quot;, TOTAL_COMPUTATION_TIME / 1e9, inactive, yielding, running));</span>

            // Add two empty line to separate the data from each host
<span class="nc" id="L227">            ps.println();</span>
<span class="nc" id="L228">            ps.println();</span>
        }
<span class="nc" id="L230">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>